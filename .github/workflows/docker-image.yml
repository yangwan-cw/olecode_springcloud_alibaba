name: ÂèëÂ∏ÉÈïúÂÉè

on:
  push:
    branches: [ "master" ]  # Ëß¶ÂèëÊù°‰ª∂ÔºöÊé®ÈÄÅÂà∞ master ÂàÜÊîØ

jobs:
  publish_dev_code:
    runs-on: ubuntu-latest
    # needs: back_java  # Á°Æ‰øùÂú®Â§á‰ªΩ‰ª£Á†Å‰Ωú‰∏öÊàêÂäüÂêéÊâçÊâßË°å
    steps:
      - name: ÊâìÂç∞‰ø°ÊÅØ üéâ
        run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."

      - name: ÊâìÂç∞Êìç‰ΩúÁ≥ªÁªü‰ø°ÊÅØ üêß
        run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"

      - name: ÊâìÂç∞ÂàÜÊîØÂíå‰ªìÂ∫ì‰ø°ÊÅØ üîé
        run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Ê£ÄÊü•‰ªìÂ∫ì‰ª£Á†Å üëÅÔ∏é
        uses: actions/checkout@v4

      - name: ÊâìÂç∞‰ªìÂ∫ìÊñá‰ª∂ÂàóË°® üì¶
        run: ls ${{ github.workspace }}

      - name: Êü•Áúã zip Êñá‰ª∂ üì¶
        run: ls

      - name: Âà†Èô§‰πãÂâçÁöÑÊñá‰ª∂
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          LASTSSH: "Doing something after copying"
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          user: ${{ secrets.DEV_SERVER_USER }}
          pass: ${{ secrets.DEV_SERVER_PASSWORD }}
          last_ssh: |
            cd /opt/app/test
            rm -rf *   # Âà†Èô§ÁõÆÂΩï‰∏ãÊâÄÊúâÊñá‰ª∂ÂíåÂ≠êÁõÆÂΩï

      - name: ÊâìÂåÖ‰ª£Á†ÅÊàê ZIP Êñá‰ª∂ üì¶
        id: deploy
        run: |
          zip -r publish.zip . -x "*.git*"
          echo "::set-output name=zip-path::publish.zip"

      - name: Êé®ÈÄÅÂà∞ÊµãËØïÊúçÂä°Âô®Â§á‰ªΩ zip Êñá‰ª∂Â§π
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          LASTSSH: "Doing something after copying"
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          user: ${{ secrets.DEV_SERVER_USER }}
          pass: ${{ secrets.DEV_SERVER_PASSWORD }}
          scp: |
            ./publish.zip => /opt/app/zip
          last_ssh: |
            ls

      - name: Êé®ÈÄÅÂà∞ÊµãËØïÊúçÂä°Âô®Â§á‰ªΩ zip Êñá‰ª∂Â§π
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          LASTSSH: "Doing something after copying"
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          user: ${{ secrets.DEV_SERVER_USER }}
          pass: ${{ secrets.DEV_SERVER_PASSWORD }}
          scp: |
            ./publish.zip => /opt/app/test
          last_ssh: |
            ls

      - name: Ëß£ÂéãÊñá‰ª∂publish.zip
        uses: easingthemes/ssh-deploy@v4.1.8
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_USER: ${{ secrets.DEV_SERVER_USER }}
          REMOTE_HOST: ${{ secrets.DEV_SERVER_HOST }}
          REMOTE_PORT: 22
          SCRIPT_AFTER: |
            cd /opt/app/test
            unzip publish.zip
            

      - name: ÊâìÂåÖ maven
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          LASTSSH: "Doing something after copying"
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          user: ${{ secrets.DEV_SERVER_USER }}
          pass: ${{ secrets.DEV_SERVER_PASSWORD }}
          last_ssh: |
            cd /opt/app/test
            mvn clean install

#      - name: mvn ÊâìÂåÖ
#        uses: easingthemes/ssh-deploy@v4.1.8
#        with:
#          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
#          REMOTE_USER: ${{ secrets.DEV_SERVER_USER }}
#          REMOTE_HOST: ${{ secrets.DEV_SERVER_HOST }}
#          REMOTE_PORT: 22
#          SCRIPT_AFTER: |
#            cd /opt/app/test
#            mvn clean install

      - name: ËøêË°å env ÈïúÂÉè
        uses: easingthemes/ssh-deploy@v4.1.8
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_USER: ${{ secrets.DEV_SERVER_USER }}
          REMOTE_HOST: ${{ secrets.DEV_SERVER_HOST }}
          REMOTE_PORT: 22
          SCRIPT_AFTER: |
            cd /opt/app/test
            docker-compose -f docker-compose.env.yml up -d

      - name: ËøêË°å env ÈïúÂÉè
        uses: easingthemes/ssh-deploy@v4.1.8
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_USER: ${{ secrets.DEV_SERVER_USER }}
          REMOTE_HOST: ${{ secrets.DEV_SERVER_HOST }}
          REMOTE_PORT: 22
          SCRIPT_AFTER: |
            cd /opt/app/test
            docker-compose -f docker-compose.service.yml up -d
      - name: ÊâìÂç∞‰Ωú‰∏öÁä∂ÊÄÅ üçè
        run: echo "üçè This job's status is ${{ job.status }}."
