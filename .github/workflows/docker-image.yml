name: Docker Compose Management

on:
  push:
    branches: [ "master" ]  # è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master åˆ†æ”¯
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  back_java:
    runs-on: ubuntu-latest
    outputs:
      backup_zip: ${{ steps.backup.outputs.zip-path }}  # æä¾› ZIP æ–‡ä»¶è·¯å¾„ä½œä¸ºè¾“å‡º
    steps:
      - name: æ‰“å°ä¿¡æ¯ ğŸ‰
        run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."

      - name: æ‰“å°æ“ä½œç³»ç»Ÿä¿¡æ¯ ğŸ§
        run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"

      - name: æ‰“å°åˆ†æ”¯å’Œä»“åº“ä¿¡æ¯ ğŸ”
        run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: æ£€æŸ¥ä»“åº“ä»£ç  ğŸ‘ï¸
        uses: actions/checkout@v4

      - name: æ‰“å°ä»“åº“æ–‡ä»¶åˆ—è¡¨ ğŸ“¦
        run: ls ${{ github.workspace }}

      - name: æ‰“åŒ…ä»£ç æˆ ZIP æ–‡ä»¶ ğŸ“¦
        id: backup
        run: |
          zip -r code.zip . -x "*.git*"
          echo "::set-output name=zip-path::code.zip"

      - name: æŸ¥çœ‹ zip æ–‡ä»¶ ğŸ“¦
        run: ls

      - name: æ¨é€åˆ°å¤‡ä»½æœåŠ¡å™¨
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          LASTSSH: "Doing something after copying"
        with:
          host: ${{ secrets.SERVER_HOST }}
          user: ${{ secrets.SERVER_USER }}
          pass: ${{ secrets.SERVER_PASSWORD }}
          scp: |
            ./code.zip => /opt/app/zip/code.zip
          last_ssh: |
            ls

      - name: æ‰“å°ä½œä¸šçŠ¶æ€ ğŸ
        run: echo "ğŸ This job's status is ${{ job.status }}."

  publish_dev_code:
    runs-on: ubuntu-latest
    # needs: back_java  # ç¡®ä¿åœ¨å¤‡ä»½ä»£ç ä½œä¸šæˆåŠŸåæ‰æ‰§è¡Œ
    steps:
      - name: æ‰“å°ä¿¡æ¯ ğŸ‰
        run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."

      - name: æ‰“å°æ“ä½œç³»ç»Ÿä¿¡æ¯ ğŸ§
        run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"

      - name: æ‰“å°åˆ†æ”¯å’Œä»“åº“ä¿¡æ¯ ğŸ”
        run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: æ£€æŸ¥ä»“åº“ä»£ç  ğŸ‘ï¸
        uses: actions/checkout@v4

      - name: æ‰“å°ä»“åº“æ–‡ä»¶åˆ—è¡¨ ğŸ“¦
        run: ls ${{ github.workspace }}

      - name: æŸ¥çœ‹ zip æ–‡ä»¶ ğŸ“¦
        run: ls

      #      - name: æ¸…ç©ºä¹‹å‰çš„æ—§æ–‡ä»¶å¤¹
      #        uses: easingthemes/ssh-deploy@v4.1.8
      #        with:
      #          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      #          REMOTE_USER: ${{ secrets.DEV_SERVER_USER }}
      #          REMOTE_HOST: ${{ secrets.DEV_SERVER_HOST }}
      #          REMOTE_PORT: 22
      #          SCRIPT_AFTER: |
      #            cd /opt/app/test
      #            rm -rf *   # åˆ é™¤ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•


      - name: åˆ é™¤ä¹‹å‰çš„æ–‡ä»¶
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          LASTSSH: "Doing something after copying"
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          user: ${{ secrets.DEV_SERVER_USER }}
          pass: ${{ secrets.DEV_SERVER_PASSWORD }}
          last_ssh: |
            cd /opt/app/test
            rm -rf *   # åˆ é™¤ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•

      - name: æ‰“åŒ…ä»£ç æˆ ZIP æ–‡ä»¶ ğŸ“¦
        id: deploy
        run: |
          zip -r publish.zip . -x "*.git*"
          echo "::set-output name=zip-path::publish.zip"

      - name: æ¨é€åˆ°æµ‹è¯•æœåŠ¡å™¨å¤‡ä»½ zip æ–‡ä»¶å¤¹
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          LASTSSH: "Doing something after copying"
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          user: ${{ secrets.DEV_SERVER_USER }}
          pass: ${{ secrets.DEV_SERVER_PASSWORD }}
          scp: |
            ./publish.zip => /opt/app/zip
          last_ssh: |
            ls

      - name: æ¨é€åˆ°æµ‹è¯•æœåŠ¡å™¨å¤‡ä»½ zip æ–‡ä»¶å¤¹
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          LASTSSH: "Doing something after copying"
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          user: ${{ secrets.DEV_SERVER_USER }}
          pass: ${{ secrets.DEV_SERVER_PASSWORD }}
          scp: |
            ./publish.zip => /opt/app/test
          last_ssh: |
            ls

      - name: è§£å‹æ–‡ä»¶å¹¶è¿è¡Œ Docker Compose
        uses: easingthemes/ssh-deploy@v4.1.8
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_USER: ${{ secrets.DEV_SERVER_USER }}
          REMOTE_HOST: ${{ secrets.DEV_SERVER_HOST }}
          REMOTE_PORT: 22
          SCRIPT_AFTER: |
            cd /opt/app/test
            unzip publish.zip
            mvn clean install 
            docker-compose -f docker-compose.env.yml up -d
            docker-compose -f docker-compose.service.yml up -d
      - name: æ‰“å°ä½œä¸šçŠ¶æ€ ğŸ
        run: echo "ğŸ This job's status is ${{ job.status }}."
